<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-1">
        <createTable tableName="region_court">
            <column name="court" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="region_courtPK"/>
            </column>
            <column name="region" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="region_courtPK"/>
            </column>
            <column name="order" type="INTEGER"/>
        </createTable>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-2">
        <addColumn tableName="region">
            <column name="level" type="int8"/>
        </addColumn>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-3">
        <addColumn tableName="region">
            <column name="parent" type="int8"/>
        </addColumn>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-4">
        <sql>
            UPDATE region r
            SET level =
                        (SELECT MIN(c.level) FROM court c WHERE c.region = r.id)
            WHERE level is null;
            UPDATE region r
            SET parent =
                    (SELECT DISTINCT (p.region)
                     FROM court c
                              LEFT JOIN court p ON c.parent = p.id
                     WHERE c.region = r.id
                       AND c.level = r.level)
            WHERE parent IS NULL;
        </sql>
        <comment>Pick region level as level of its top court. To pick parent region
            find top court, get its parent court, get its region.
        </comment>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-5">
        <addNotNullConstraint tableName="region" columnName="level"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-6">
        <addUniqueConstraint columnNames="court" constraintName="region_court_court_uniq" tableName="region_court"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-7">
        <addForeignKeyConstraint baseColumnNames="court" baseTableName="region_court"
                                 constraintName="region_court_court_fk" deferrable="false" initiallyDeferred="false"
                                 referencedColumnNames="id" referencedTableName="court" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-8">
        <addForeignKeyConstraint baseColumnNames="region" baseTableName="region_court"
                                 constraintName="region_court_region_fk" deferrable="false" initiallyDeferred="false"
                                 referencedColumnNames="id" referencedTableName="region" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-9">
        <addForeignKeyConstraint baseColumnNames="parent" baseTableName="region" constraintName="region_parent_fk"
                                 deferrable="false" initiallyDeferred="false" referencedColumnNames="id"
                                 referencedTableName="region" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-10">
        <sql>
            INSERT INTO region_court (court, region, "order")
            SELECT c.id, r.id, row_number() OVER (PARTITION BY r.id ORDER BY c.id) - 1 FROM court c JOIN region r ON c.region = r.id;
        </sql>
        <comment>Ordering column must start from 0.</comment>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1638559724720-11">
        <dropNotNullConstraint tableName="court" columnName="region"/>
    </changeSet>
</databaseChangeLog>
