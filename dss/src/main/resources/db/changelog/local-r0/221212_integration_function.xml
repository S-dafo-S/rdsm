<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-2">
        <createTable tableName="integration_function">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="integration_functionPK"/>
            </column>
            <column name="description" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="original_filename" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="uploaded_filename" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="creation_date" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="update_date" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="source_query_impl_temp" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-3">
        <createTable tableName="integration_function_connector">
            <column name="integration_function_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="key" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="kind" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-4">
        <createTable tableName="integration_function_param">
            <column name="integration_function_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="key" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-8">
        <addUniqueConstraint columnNames="integration_function_id, key"
                             constraintName="integration_function_connector_key_uniq"
                             tableName="integration_function_connector"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-9">
        <addUniqueConstraint columnNames="name" constraintName="integration_function_name_uniq"
                             tableName="integration_function"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-14">
        <addForeignKeyConstraint baseColumnNames="integration_function_id"
                                 baseTableName="integration_function_connector"
                                 constraintName="integration_function_connector_func_fk" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id"
                                 referencedTableName="integration_function" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-15">
        <addForeignKeyConstraint baseColumnNames="integration_function_id" baseTableName="integration_function_param"
                                 constraintName="integration_function_param_func_fk" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id"
                                 referencedTableName="integration_function" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-16">
        <sql>
            INSERT INTO integration_function(name, original_filename, uploaded_filename, creation_date, update_date,
                                             source_query_impl_temp)
            SELECT concat(qImpl.name, '_', jImpl.impl_filename),
                   jImpl.impl_filename,
                   jImpl.impl_filename,
                   now(),
                   now(),
                   jimpl.id
            FROM java_query_implementation jImpl
                     JOIN query_implementation qImpl ON jImpl.id = qImpl.id
            WHERE jImpl.impl_filename IS NOT NULL;
        </sql>
        <comment>Migration from java query impl filename to integration function</comment>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-17">
        <sql>
            INSERT INTO integration_function_connector(integration_function_id, key, kind)
            SELECT ifunc.id, qdc.key, qdc.kind
            FROM java_query_implementation jImpl
                     JOIN query_implementation_data_connector qdc ON qdc.query_impl = jImpl.id
                     JOIN integration_function ifunc ON jImpl.id = ifunc.source_query_impl_temp
            WHERE jImpl.impl_filename IS NOT NULL;
        </sql>
        <comment>Fill integration functions with data connector info</comment>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-18">
        <sql>
            INSERT INTO integration_function_param(integration_function_id, key)
            SELECT ifunc.id, qp.name
            FROM java_query_implementation jImpl
                     JOIN query_implementation_param qp ON qp.query_impl_id = jImpl.id
                     JOIN integration_function ifunc ON jImpl.id = ifunc.source_query_impl_temp
            WHERE jImpl.impl_filename IS NOT NULL;
        </sql>
        <comment>Fill integration functions with param info</comment>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-19">
        <addColumn tableName="java_query_implementation">
            <column name="integration_function" type="int8"/>
        </addColumn>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-20">
        <addForeignKeyConstraint baseColumnNames="integration_function" baseTableName="java_query_implementation"
                                 constraintName="java_query_implementation_int_function_fk" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id"
                                 referencedTableName="integration_function" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-21">
        <sql>
            UPDATE java_query_implementation jimpl
            SET integration_function =
                    (SELECT id FROM integration_function ifunc WHERE ifunc.source_query_impl_temp = jimpl.id);
            <comment>Migration for java query implementation and integration function link</comment>
        </sql>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-22">
        <createTable tableName="integration_function_entry">
            <column name="function_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="service_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-23">
        <addUniqueConstraint columnNames="class_name" constraintName="integration_function_entry_classname_uniq"
                             tableName="integration_function_entry"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-24">
        <addForeignKeyConstraint baseColumnNames="function_id" baseTableName="integration_function_entry"
                                 constraintName="integration_function_entry_func_fk" deferrable="false"
                                 initiallyDeferred="false" referencedColumnNames="id"
                                 referencedTableName="integration_function" validate="true"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-25">
        <sql>
            INSERT INTO integration_function_entry(function_id, class_name, service_name)
            SELECT ifunc.id, entry.class_name, entry.service_name
            FROM java_plugin_entry entry
                     JOIN java_query_implementation impl
                          ON entry.query_impl_id = impl.id
                     JOIN integration_function ifunc
                          ON ifunc.source_query_impl_temp = impl.id;
        </sql>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1670854762061-26">
        <dropTable tableName="java_plugin_entry"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1671572698540-27">
        <dropColumn columnName="impl_filename" tableName="java_query_implementation"/>
    </changeSet>
    <changeSet author="emamontova@soylent.io (generated)" id="1671572698540-28">
        <dropColumn columnName="source_query_impl_temp" tableName="integration_function"/>
    </changeSet>
</databaseChangeLog>
